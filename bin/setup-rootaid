#!/bin/bash

UID=$(id -u)
if [ ${UID} -neq 0 ]
then
    echo "$0: Please execute this script as root"
    exit 1
fi

set -o nounset

[ -f setup-rootaid.conf ] && . setup-rootaid.conf
ROOTAID_USER=${ROOTAID_USER:-"rootaid"}
ROOTAID_HOME="${ROOTAID_HOME:-/home/${ROOTAID_USER}}"
ROOTAID_UID=${ROOTAID_UID:-1007}
ROOTAID_GID=${ROOTAID_GID:-1003}

sudo addgroup --gid ${ROOTAID_GID} ${ROOTAID_USER}
sudo adduser --uid ${ROOTAID_UID} --ingroup ${ROOTAID_USER} --home ${ROOTAID_HOME} --disabled-password --gecos "Rootaid" ${ROOTAID_USER}

sudo apt-get -y install git
ROOTAID_REPO_NAME='eu.artofcoding.rootaid'
pushd ${ROOTAID_HOME}
ssh-keygen -R bitbucket.org
ssh-keyscan bitbucket.org >>${HOME}/.ssh/known_hosts
git clone --depth 1 https://bitbucket.org/artofcoding/${ROOTAID_REPO_NAME}.git
popd
echo "0 * * * * ( cd ${ROOTAID_REPO_NAME} ; git pull )" | sudo crontab -u ${ROOTAID_USER} -

sudo touch ${ROOTAID_HOME}/.bashrc

sudo mkdir ${ROOTAID_HOME}/.ssh
sudo touch ${ROOTAID_HOME}/.ssh/authorized_keys

sudo mkdir ${ROOTAID_HOME}/apache
sudo mkdir ${ROOTAID_HOME}/apache/conf

sudo chown -R ${ROOTAID_USER}:${ROOTAID_USER} ${ROOTAID_HOME}
sudo chmod -R go=u-w ${ROOTAID_HOME}
sudo chmod -R go= ${ROOTAID_HOME}/.ssh

cat >>${ROOTAID_HOME}/.bashrc <<EOF

# Rootaid
PATH=\$HOME/${ROOTAID_REPO_NAME}/bin:\$PATH
export PATH
EOF

# For root
cat >>/root/.bashrc <<EOF

# Rootaid
PATH=${ROOTAID_HOME}/${ROOTAID_REPO_NAME}/bin:\$PATH
export PATH
EOF

# Apache
cat >>/etc/apache2/apache2.conf <<EOF

# Rootaid
#Include ${ROOTAID_HOME}/${ROOTAID_REPO_NAME}/apache/dir-structure.conf
#Include ${ROOTAID_HOME}/${ROOTAID_REPO_NAME}/apache/default-cache.conf
#Include ${ROOTAID_HOME}/${ROOTAID_REPO_NAME}/apache/pagespeed-global.conf
#Include ${ROOTAID_HOME}/${ROOTAID_REPO_NAME}/apache/php-security.conf
EOF

exit 0
